 ***chapter6 <并行处理 >***
Amdahl定律，向量指令，GPU
# 7.0 前述
对于并行处理我们可以从两个层面考虑
- 硬件层面
	- 串行
		一条一条地处理指令
	- 并行
		同时处理指令
- 软件层面
	- 顺序
		指令一条一条地运行
	- 并发
		多条指令同时执行
	- PS
		单发射CPI = 1
- 问题
	- 负载均衡 <任务的划分到子任务>
	- 协调 <同步(任务之间)保证正确性>
	- 交流协调
# 7.1 Basis
# 7.1.0 标准术语
- 带宽 Bandwidth
	传输数据的字节数/周期数

- 总线连接串口-键盘鼠标
- 总线连接设备接口-声卡|显卡|网卡

# 7.2 Amdahl定律
- 最基本的公式
	$T_{improved} =  \frac{T_{affected}}{improved factor优化量} + T_{unaffected}$
- 公式推导
	$Speed = \frac{T_{old}}{T_{new}}$
	$Speed = \frac{T_{old}}{T_{old} - T_{affected} + \frac{T_{affected}}{n优化量}}$
	对于上式分子分母同时除$T_{old}$
	$Speed = \frac{1}{1 - F + \frac{F}{n优化量}}$
	其中$F = \frac{T_{affected}}{T_{old}}$
	通常优化量n与处理硬件数量有关
- 基本术语
	Scalars-标量-离散的数据
- 强缩放与弱缩放
	- 强比例缩放
		任务数量不变,处理单元(硬件)增加
	- 弱比例缩放
		任务与处理器同时增加(同比例)
- 流水线处理器 - 超标量处理器
# 7.3 指令-数据流
- 基础概念
	![[Pasted image 20241230170630.png]]
	- SISD
		单指令单数据流 例如add x5,x6,x6 一条指令处理一个数据流
	- SIMD
		单指令多数据流 例如处理声音和图像
		初衷是为了把控制单元的成本平摊到数个执行单元上
		减少了指令带宽和空间
	- MIMD
		SPMD(Single Program Mutiple Data)
		一个可以并行的处理器 在MIMD中
		对于不同处理器提供状态代码

- Vector Processors向量处理器架构
	- 向量寄存器
		一个向量体系结构中可能有32个向量寄存器
		每个寄存器包含64个64位宽的数据元
	- fadd.d.v
		vector与vector相加
	- fadd.d.vs
		vector和scalar相加
		将标量加于每个向量元素之上
	- fld.v & fsd.v
	- 循环展开。。。。。。
- temp
	- 多CPU-指令级并行
	- 数据级并行-指令相同，数据不同
	- 向量运算 可以减少循环代价
	- SIMD-数据级并行
	- 向量指令 支持步长读取(一次读取多个数据)
	- 进程切换时需要上下文切换 所以通用处理器很少用数据并行架构


- 硬件多线程 关于MIMD的一个概念
	- 线程
		包含线程ID，程序计数器(指向当前执行的指令地址，相当于PC)，寄存器与堆栈
		是一个轻量级的进程，是系统能够调用的最小单元
		线程通常共享一个地址空间，但是进程不共享
	- 进程
		包含一个或多个线程，完整的地址空间和操作系统状态
		进程的切换通常需要调用操作系统
		而线程的切换不需要
	- Example1
		对于播放器来说
		有data接收线程，播放线程，以及buffer存放数据
		data接收线程需要和播放线程同步
	- 细粒度多线程调度
		每一个周期切换 吞吐量增加
	- 粗粒度多线程调度
		一直进行在长期阻塞时才切换 吞吐量减少 每周期执行时间缩短
	- 同时多线程SMT
		线程< PC RF 栈 硬件>
		SMP共享内存-多处理器
		实现操作支持-锁
	- UMA & NUMA
		- UMA统一内存访问处理器
		- NUMA非同一内存访问处理器
		。。。。。。

- 并行编程
	- Reduction 归约例如加法运算


- GPU<协处理器>
- 最初是对于图像进行处理
	对于三角形顶点计算-栅格化数据(3D->2D并有立体感)
- 多线程并行
	- CPU-阻塞
	- GPU-切换
	CUDA并行编程语言系统 连接CPU与GPU
	Direct X，OpenGL直接与硬件相联


- NVIDIA Fermi架构
- GPU是由多线程SIMD处理器组成的MIMD
	Multiple SIMD SM流处理器即 SIMD处理器 Streaming Multiprocessor (SM)
	线程块调度器硬件 为多线程SIMD处理器分配线程块
- 调度器
	- 线程块调度器
		给多线程SIMD处理器分配线程块
	- SIMD线程调度器
		位于SIMD线程处理器内部，可再SIMD线程运行时进行调度
	这些线程的SIMD指令宽度位32 
- 结构
	每个线程的SIMD指令宽度为32
	可以映射到16个SIMD通道 一个通道就是一个线程
	所以线程中的每个SIMD指令需要两个周期才能完成 
	且SIMD指令的每个线程都是同步执行的
	
	所以有16个SIMD通道(线程处理器)
	每个SIMD线程处理器有64个**向量寄存器**(可以类比为数组)
	每个向量寄存器寄存器包含32个元素 每个元素32位
	所以一个SIMD通道 包含 64x32个32bits = 2k个32bits 寄存器
	一个多线程SIMD处理器 就一共包含16个线程 32k个32bits寄存器
	
	每个SM包含32各CUDA Kernel单核处理器
	每个core有子集的共享Memory，栈，与一级cache
	这32个core分布如下
	- 有16个core
	- 有16个core
	- 有16个读写单元
	- 有四个 SFU特殊函数单元(正弦函数)
	- shared Memory
	多个SM共用2级cache
- 线程Thread | 线程束warp | 线程块block | 线程网络grid
	32个线程 构成 1个线程束
	其中多线程SIMD 调度是以warp为单位的
- GPU的整体结构
	![[Pasted image 20250108212843.png]]
	Core是向量的运算单元
	每个Core中包含一个整数运算单元ALU与一个浮点数运算单元FPU